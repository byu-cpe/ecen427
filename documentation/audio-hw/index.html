<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="">
<meta name="author" content="">

<title>
    
    Audio Hardware â€¢ ECEn 427
    
</title>

<!-- Bootstrap core CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
    integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

<!-- Custom styles for this template -->
<link rel="stylesheet" href=/ecen427/css/main.css>

<!-- <link href="https://fonts.googleapis.com/css?family=Ubuntu&display=swap" rel="stylesheet"> -->
<!-- <link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono&display=swap" rel="stylesheet"> -->
<link rel="stylesheet" href="https://use.typekit.net/jcn6ybb.css">

<!-- <link rel="icon" type="image/png" sizes="96x96" href=/ecen427/icon/favicon-96x96.png>
<link rel="icon" type="image/png" sizes="32x32" href=/ecen427/icon/favicon-32x32.png>
<link rel="icon" type="image/png" sizes="16x16" href=/ecen427/icon/favicon-16x16.png> -->

<script src="https://kit.fontawesome.com/d794f0229e.js" crossorigin="anonymous"></script>

</head>

<body>
  <div class="d-flex" id="wrapper">
    <div class="border-right sidebar-color" id="sidebar-wrapper">
    <div class="sidebar-sticky">
        <div class="sidebar-heading-big">
            <a href="/ecen427/">
                ECEn 427</a>

        </div>

        <div class="search-bar">
            <form method="get" action="https://www.google.com/search" target="_blank">
                <input class="search-box" type="hidden" name="sitesearch" value="https://byu-cpe.github.io/ecen427" />
                <input class="search-box" type="text" name="q" maxlength="255" placeholder="Search" />
            </form>
        </div>

        <div class="list-group list-group-flush sidebar-color">

            

            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            <a href="/ecen427/syllabus/"
                class="sidebar-color list-item-normal list-group-item list-group-item-action sidebar-item ">
                
                <i class="fas fa-chalkboard-teacher"></i>
                
                Syllabus
            </a>
            
            
            
            
            
            
            
            <a href="/ecen427/schedule/"
                class="sidebar-color list-item-normal list-group-item list-group-item-action sidebar-item ">
                
                <i class="fa fa-calendar"></i>
                
                Lab Schedule
            </a>
            
            
            
            <a href="/ecen427/reading-assignments/"
                class="sidebar-color list-item-normal list-group-item list-group-item-action sidebar-item ">
                
                <i class="fas fa-book-open"></i>
                
                Reading Assignments and Schedule
            </a>
            
            
            <!-- <a href="https://slack.com/app_redirect?team=T01J887F8MU&channel=C01JF1N6TH8"
                class="list-item-normal list-group-item list-group-item-action sidebar-item" target="_blank"><i
                    class="fa fa-question-circle"></i>
                Slack</a> -->

        </div>

        <div class="sidebar-heading">Labs</div>
        <div class="list-group list-group-flush">
            
            <a href="/ecen427/labs/hello-world/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">1</span>
                Hello World

            </a>
            
            <a href="/ecen427/labs/clock/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">2</span>
                Clock

            </a>
            
            <a href="/ecen427/labs/space-invaders/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">3</span>
                Space Invaders

            </a>
            
            <a href="/ecen427/labs/audio-driver/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">4</span>
                Audio Driver

            </a>
            
            <a href="/ecen427/labs/pit-hw/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">5</span>
                PIT Hardware

            </a>
            
            <a href="/ecen427/labs/pit-driver/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">6</span>
                PIT Driver

            </a>
            
            <a href="/ecen427/labs/hls-accelerator/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">7</span>
                HLS Accelerator

            </a>
            
        </div>

        <div class="sidebar-heading">Documentation</div>

        <div class="list-group list-group-flush">
            
            <a href="/ecen427/documentation/setup/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                

                Setup

            </a>
            
            <a href="/ecen427/documentation/setup-home-computer/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                &emsp;

                Home Computer

            </a>
            
            <a href="/ecen427/documentation/setup-pynq-board/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                &emsp;

                Setup PYNQ

            </a>
            
            <a href="/ecen427/documentation/serial/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                &emsp;&emsp;

                PYNQ Serial

            </a>
            
            <a href="/ecen427/documentation/network-communications/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                &emsp;

                PYNQ Network

            </a>
            
            <a href="/ecen427/documentation/tutorials/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                &emsp;

                Tutorials

            </a>
            
            <a href="/ecen427/documentation/config-pynq-and-github/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                &emsp;

                PYNQ & Github

            </a>
            
            <a href="/ecen427/documentation/vscode/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                &emsp;

                Setup VSCode

            </a>
            
            <a href="/ecen427/documentation/compiling-running-code/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                &emsp;

                Compiling Programs

            </a>
            
            <a href="/ecen427/documentation/software-stack/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                

                Software Stack

            </a>
            
            <a href="/ecen427/documentation/uio/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                &emsp;

                UIO

            </a>
            
            <a href="/ecen427/documentation/platform-device-tree/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                &emsp;

                Device Tree

            </a>
            
            <a href="/ecen427/documentation/linux-drivers/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                &emsp;

                Linux Drivers

            </a>
            
            <a href="/ecen427/documentation/hardware/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                

                Hardware

            </a>
            
            <a href="/ecen427/documentation/hdmi/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                &emsp;

                HDMI

            </a>
            
            <a href="/ecen427/documentation/audio-hw/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                &emsp;

                Audio Hardware

            </a>
            
            <a href="/ecen427/documentation/vivado/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                &emsp;

                Vivado

            </a>
            
            <a href="/ecen427/documentation/vivado-axi-simulation/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                &emsp;

                Simulating AXI IP

            </a>
            
        </div>

        <div class="sidebar-heading">Other</div>

        <div class="list-group list-group-flush">
            
            <a href="/ecen427/other/submission/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                

                Lab Submission

            </a>
            
            <a href="/ecen427/other/coding-standard/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                

                Coding Standard

            </a>
            
            <a href="/ecen427/other/ta-calendar/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                

                TA Calendar

            </a>
            
        </div>
    </div>
</div>

    <!-- Page Content -->
    <div id="page-content-wrapper">

      <nav class="navbar sticky-top navbar-expand-lg border-bottom">
        <button class="btn btn-brand" id="menu-toggle">
          <i class="fas fa-bars"></i>
        </button>

        <a href="#" class="navbar-brand mb-0 h1 page-title-bar text-center mx-auto" id="page-title-bar"></a>

        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link btn btn-brand suggest-edits" target="_blank" rel="noopener noreferrer"
              href="https://github.com/byu-cpe/ecen427/issues/new?labels=website&title=Updates to Audio Hardware page"><i
                class="fab fa-github"></i> Suggest
              Edits</a>
          </li>
        </ul>
      </nav>

      <div class="container">
        <article class="page">
  <h1 class="page-title" id="page-title">
    
    Audio Hardware
  </h1>

  <div class="page-content">
    

    <p>The PYNQ-Z2 board is equipped with an <a href="http://www.analog.com/media/en/technical-documentation/data-sheets/ADAU1761.pdf">Analog Devices ADAU1761</a> 24-bit audio codec chip.  In the <a href="/ecen427/documentation/hardware/">Hardware System</a>, the <em>audio_tx</em> IP core, which is connected to the AXI processor bus, can store and play small chunks of audio data.  By communicating with this hardware, you  can play audio out over the 3.5mm jack, and capture audio input through an input line.</p>

<p>To play audio you will need to perform two major tasks, 1) Configure the codec chip using the external I2C bus, and 2) supply the <em>audio_tx</em> IP core with audio data.</p>

<h2 id="configuring-the-codec-chip">Configuring the Codec Chip</h2>
<p>The audio codec chip on the PYNQ-Z2 board must be configured before it will operate correctly.  The codec chip is connected to the ZYNQ SoC via an <a href="https://en.wikipedia.org/wiki/I%C2%B2C">I2C bus</a>.  The ARM-A9 processor on the ZYNQ has a built-in I2C controller, that drives this I2C bus.  To configure the audio codec you will need to call the provided <code class="language-plaintext highlighter-rouge">audio_config_init()</code>.  This function is provided as part of a user space <a href="https://github.com/byu-cpe/ecen427_student/tree/master/userspace/drivers/audio_config">audio_config</a> driver.</p>

<h2 id="playing-audio-data">Playing Audio Data</h2>

<h3 id="audio-data-format">Audio Data Format</h3>
<p>The audio hardware expects audio data in 24-bit PCM format, at 48kHZ. Accordingly, the <strong>audio_tx</strong> hardware contains small FIFOs to store several audio samples, which is sent to the audio chip at 48kHZ.  You can read more about the PCM format in this <a href="http://www-ug.eecg.toronto.edu/msl/nios_devices/datasheets/sound_codec_power_point.pdf">document from the University of Toronto</a>.  Although this document is for a different hardware configuration than ours, the concepts still apply the same.</p>

<p>In order to play audio clips, you will want to open and read data from WAVE (.wav) audio files.  Fortunately, WAVE files store their audio data in PCM format, so minimal processing will be required between reading the audio data from the WAVE file and writing in to the TX FIFOs.</p>

<p>Some information on the format of WAVE files:</p>
<ul>
  <li><a href="http://soundfile.sapp.org/doc/WaveFormat/">http://soundfile.sapp.org/doc/WaveFormat/</a></li>
  <li><a href="https://en.wikipedia.org/wiki/WAV">https://en.wikipedia.org/wiki/WAV</a></li>
</ul>

<p>Keep in mind not all WAV files are of the same format; for example, some WAVE files may be stereo or mono, the bit depth could be 16-bit, 24-bit, etc.  <a href="https://www.audacityteam.org">Audacity</a> is installed on the lab computers and can be used to convert between audio file formats.</p>

<h3 id="hardware-system">Hardware System</h3>
<p>While configuring the codec is done using I2C, sending the actual audio data (music, sound fx) to the codec is done using the <a href="https://en.wikipedia.org/wiki/I2S">I2S</a> protocol.  The <em>audio_tx</em> IP, at a rate of 48kHZ, removes audio samples from its FIFOs, and sends them to the codec chip via the I2S pins.</p>

<p>The internals of the <em>audio_tx</em> hardware are shown here:</p>

<p><img src="/ecen427/media/audio_hw.png" width="800" /></p>

<p>There are two FIFOs that are used to play audio on the left and right channel.  You can add audio samples to these FIFOs by writing to the DataTx registers, although you will only want to do so when you know there is available space in the FIFO.</p>

<h3 id="interrupts">Interrupts</h3>
<p>The FIFOs both have a depth of 1024, and if interrupts are enabled, the audio core will generate an interrupt if either FIFO is 75% or more empty (256 or fewer occupied entries in the FIFO).</p>

<h3 id="register-map">Register map</h3>

<p><img src="/ecen427/media/audio_registers.png" width="800" /></p>

<p><strong>I2S_DATA_RX_L_REG: details</strong></p>

<table>
  <thead>
    <tr>
      <th>Bits</th>
      <th>Field Name</th>
      <th>Default Value</th>
      <th>Access Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>31-24</td>
      <td>Reserved</td>
      <td>0</td>
      <td>R</td>
      <td>Always reads as 0</td>
    </tr>
    <tr>
      <td>23-0</td>
      <td>DataRx_L</td>
      <td>0</td>
      <td>R</td>
      <td>Left channel data from the input line</td>
    </tr>
  </tbody>
</table>

<p><strong>I2S_DATA_RX_R_REG: details</strong></p>

<table>
  <thead>
    <tr>
      <th>Bits</th>
      <th>Field Name</th>
      <th>Default Value</th>
      <th>Access Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>31-24</td>
      <td>Reserved</td>
      <td>0</td>
      <td>R</td>
      <td>Always reads as 0</td>
    </tr>
    <tr>
      <td>23-0</td>
      <td>DataRx_R</td>
      <td>0</td>
      <td>R</td>
      <td>Right channel data from the input line</td>
    </tr>
  </tbody>
</table>

<p><strong>I2S_DATA_TX_L_REG: details</strong></p>

<table>
  <thead>
    <tr>
      <th>Bits</th>
      <th>Field Name</th>
      <th>Default Value</th>
      <th>Access Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>31-24</td>
      <td>Reserved</td>
      <td>0</td>
      <td>R</td>
      <td>Always reads as 0?</td>
    </tr>
    <tr>
      <td>23-0</td>
      <td>DataTx_L</td>
      <td>0</td>
      <td>W</td>
      <td>Data written to this register will be sent to the left channel of the audio out line.</td>
    </tr>
  </tbody>
</table>

<p><strong>I2S_DATA_TX_R_REG: details</strong></p>

<table>
  <thead>
    <tr>
      <th>Bits</th>
      <th>Field Name</th>
      <th>Default Value</th>
      <th>Access Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>31-24</td>
      <td>Reserved</td>
      <td>0</td>
      <td>R</td>
      <td>Always reads as 0?</td>
    </tr>
    <tr>
      <td>23-0</td>
      <td>DataTx_R</td>
      <td>0</td>
      <td>W</td>
      <td>Data written to this register will be sent to the  right channel of the audio out line.</td>
    </tr>
  </tbody>
</table>

<p><strong>I2S_STATUS_REG: details</strong></p>

<table>
  <thead>
    <tr>
      <th>Bits</th>
      <th>Field Name</th>
      <th>Default Value</th>
      <th>Access Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>31-22</td>
      <td>Reserved</td>
      <td>0</td>
      <td>R</td>
      <td>Always reads as 0</td>
    </tr>
    <tr>
      <td>21</td>
      <td>DATA_RDY</td>
      <td>0</td>
      <td>R/W</td>
      <td>Each time a new audio input sample is available in the DataRx registers, this bit will be set to 1.  At any point the user can write a 0 to clear this bit.</td>
    </tr>
    <tr>
      <td>20-11</td>
      <td>TX_DATACOUNT_L</td>
      <td>0</td>
      <td>R</td>
      <td>Indicates the number of values currently in the audio FIFO on the left channel.</td>
    </tr>
    <tr>
      <td>10-1</td>
      <td>TX_DATACOUNT_R</td>
      <td>0</td>
      <td>R</td>
      <td>Indicates the number of values currently in the audio FIFO on the right channel.</td>
    </tr>
    <tr>
      <td>0</td>
      <td>INT_EN</td>
      <td>0</td>
      <td>R/W</td>
      <td>Controls the interrupt generation coming from the audio hardware.  <em>Writes:</em> Changes the interrupt generation operation.  <em>Reads:</em> Returns the status of the interrupt generation (0 = interrupts disabled, 1 = interrupts enabled).</td>
    </tr>
  </tbody>
</table>

  </div>
</article>
      </div>
    </div>
    <!-- /#page-content-wrapper -->

  </div>
  <!-- /#wrapper -->

  <!-- Bootstrap core JavaScript -->
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>
<script src=/ecen427/js/jquery.visible.min.js></script>

<!-- Menu Toggle Script -->
<script>
    $("#menu-toggle").click(function (e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });

    var prevVisible = $('#page-title').visible();

    $(window).scroll(function () {
        currentVisible = $('#page-title').visible()
        if (prevVisible && !currentVisible) {
            console.log("Do something!");
            $("#page-title-bar").html($('#page-title').text());
        }

        if (!prevVisible && currentVisible) {
            $("#page-title-bar").html("")
        }

        prevVisible = currentVisible;
    });

</script>

</body>

</html>